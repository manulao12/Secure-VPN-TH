<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiration Date Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase debug logs
        setLogLevel('debug');

        // Global variables for Firebase services
        let app, db, auth;
        let userId = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication logic
            onAuthStateChanged(auth, async (user) => {
                const userStatusEl = document.getElementById('user-status');
                const loadingIndicator = document.getElementById('loading');
                if (user) {
                    userId = user.uid;
                    userStatusEl.textContent = `Signed in. User ID: ${userId}`;
                    loadingIndicator.classList.add('hidden');
                    loadItems();
                } else {
                    userStatusEl.textContent = 'Signing in...';
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            userStatusEl.textContent = 'Sign-in failed. Please try again.';
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            userStatusEl.textContent = 'Sign-in failed. Please try again.';
                        }
                    }
                }
            });
        } else {
            document.getElementById('loading').textContent = "Firebase is not configured. Please ensure __firebase_config is available.";
            document.getElementById('form-container').classList.add('hidden');
        }

        // --- Functions to calculate days left and status ---
        const getDaysLeft = (expirationDate) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expDate = new Date(expirationDate);
            expDate.setHours(0, 0, 0, 0);

            const timeDiff = expDate.getTime() - today.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return dayDiff;
        };

        const getStatus = (daysLeft) => {
            if (daysLeft < 0) return 'Expired';
            if (daysLeft <= 7) return 'Expires Soon';
            return 'Active';
        };

        const getStatusColor = (status) => {
            switch (status) {
                case 'Expired': return 'bg-red-500';
                case 'Expires Soon': return 'bg-yellow-500';
                default: return 'bg-green-500';
            }
        };

        // --- Firestore Operations ---
        const loadItems = () => {
            if (!db || !userId) return;

            const itemsRef = collection(db, `artifacts/${appId}/users/${userId}/items`);
            
            // onSnapshot provides real-time updates
            onSnapshot(itemsRef, (snapshot) => {
                const itemsList = document.getElementById('items-list');
                itemsList.innerHTML = '';
                if (snapshot.empty) {
                    itemsList.innerHTML = '<p class="text-center text-gray-500">No items added yet. Add your first item above!</p>';
                    return;
                }

                const items = [];
                snapshot.forEach(doc => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                // Sort items by expiration date
                items.sort((a, b) => new Date(a.expirationDate) - new Date(b.expirationDate));

                items.forEach(item => {
                    const daysLeft = getDaysLeft(item.expirationDate);
                    const status = getStatus(daysLeft);
                    const statusColor = getStatusColor(status);

                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white p-4 rounded-lg shadow-md flex justify-between items-center space-x-4';
                    itemEl.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                            <p class="text-sm text-gray-500">Expires: ${new Date(item.expirationDate).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-500">Days left: ${daysLeft}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs font-bold text-white rounded-full ${statusColor}">${status}</span>
                            <button class="delete-btn text-red-500 hover:text-red-700 transition-colors duration-200 focus:outline-none" data-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    itemsList.appendChild(itemEl);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        deleteItem(id);
                    });
                });
            }, (error) => {
                console.error("Error loading items:", error);
                document.getElementById('items-list').innerHTML = `<p class="text-center text-red-500">Error loading items: ${error.message}</p>`;
            });
        };

        const addItem = async (name, expirationDate) => {
            if (!db || !userId) {
                console.error("Firestore not ready.");
                showStatusMessage("App is not ready. Please wait a moment.", "bg-red-500");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/items`), {
                    name,
                    expirationDate,
                    createdAt: new Date().toISOString()
                });
                showStatusMessage("Item added successfully!", "bg-green-500");
            } catch (e) {
                console.error("Error adding document: ", e);
                showStatusMessage("Error adding item. Please check the console.", "bg-red-500");
            }
        };

        const deleteItem = async (id) => {
            if (!db || !userId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/items`, id));
                showStatusMessage("Item deleted successfully!", "bg-yellow-500");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showStatusMessage("Error deleting item. Please check the console.", "bg-red-500");
            }
        };

        // --- UI Logic ---
        const showStatusMessage = (message, color) => {
            const statusMessageEl = document.getElementById('status-message');
            statusMessageEl.textContent = message;
            statusMessageEl.className = `p-2 mt-4 text-white text-sm rounded-md transition-all duration-300 ${color}`;
            statusMessageEl.classList.remove('opacity-0', 'scale-95');
            statusMessageEl.classList.add('opacity-100', 'scale-100');

            setTimeout(() => {
                statusMessageEl.classList.remove('opacity-100', 'scale-100');
                statusMessageEl.classList.add('opacity-0', 'scale-95');
            }, 3000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('add-item-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('item-name').value.trim();
                const expirationDate = document.getElementById('item-exp-date').value;

                if (!name || !expirationDate) {
                    showStatusMessage("Please fill out all fields.", "bg-red-500");
                    return;
                }
                addItem(name, expirationDate);
                form.reset();
            });
        });
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-900">
    <div class="min-h-screen flex flex-col items-center p-4">
        <header class="w-full max-w-2xl text-center py-6">
            <h1 class="text-4xl font-extrabold text-gray-800">
                Expiration Date Manager
            </h1>
            <p class="mt-2 text-lg text-gray-600">
                Track your expiring items.
            </p>
        </header>

        <div id="loading" class="text-center text-gray-500 mt-8">Loading...</div>
        <p id="user-status" class="text-sm text-gray-500 mt-2 break-all"></p>

        <main class="w-full max-w-2xl mt-8">
            <!-- Form to add new items -->
            <div id="form-container" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Item</h2>
                <form id="add-item-form" class="space-y-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="item-name" placeholder="e.g., Milk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="item-exp-date" class="block text-sm font-medium text-gray-700">Expiration Date</label>
                        <input type="date" id="item-exp-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        Add Item
                    </button>
                </form>
            </div>

            <!-- List of items -->
            <div class="space-y-4">
                <div id="items-list" class="flex flex-col space-y-4">
                    <!-- Items will be populated here by JavaScript -->
                </div>
            </div>
            
            <!-- Status message container -->
            <div id="status-message" class="absolute bottom-4 right-4 p-3 rounded-lg shadow-lg text-white font-medium opacity-0 scale-95 transition-all duration-300"></div>
        </main>
    </div>
</body>
</html>
